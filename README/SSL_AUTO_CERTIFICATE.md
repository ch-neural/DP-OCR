# SSL 自動憑證功能說明

## 📋 目錄

- [概述](#概述)
- [功能特點](#功能特點)
- [使用方式](#使用方式)
- [依賴套件](#依賴套件)
- [憑證規格](#憑證規格)
- [安全注意事項](#安全注意事項)
- [常見問題](#常見問題)

---

## 概述

`book_reader_remote.py` 現在支援**自動檢查並建立 SSL 自簽憑證**，讓用戶不需要手動建立憑證，即可使用 HTTPS 模式啟動服務。

這是因為現代瀏覽器要求必須在 HTTPS 環境下才能使用 Webcam 功能（`getUserMedia` API）。

### 為什麼需要 HTTPS？

| 功能 | HTTP | HTTPS |
|------|------|-------|
| 基本網頁瀏覽 | ✅ | ✅ |
| 圖片上傳 | ✅ | ✅ |
| **Webcam 存取** | ❌ | ✅ |
| **麥克風存取** | ❌ | ✅ |
| 地理位置 | ❌ | ✅ |

> 💡 **例外**：`localhost` 被視為安全環境，可以在 HTTP 下使用 Webcam，但區網 IP 則需要 HTTPS。

## 功能特點

1. **自動檢查**：程式啟動時自動檢查 SSL 憑證是否存在
2. **自動建立**：如果憑證不存在或已過期，自動生成新的自簽憑證
3. **有效期檢查**：檢查憑證是否即將過期（7天內），如果是則自動更新
4. **多 IP 支援**：自動偵測本機所有 IP 地址，並加入憑證的 Subject Alternative Names
5. **零配置**：用戶只需執行程式，無需任何額外操作

## 使用方式

### 基本使用

```bash
cd example_bookReader
python book_reader_remote.py
```

程式會自動：
1. 檢查 `cert.pem` 和 `key.pem` 是否存在
2. 如果不存在，自動建立 SSL 自簽憑證
3. 使用 HTTPS 模式啟動伺服器

### 輸出範例

```
============================================================
📖 Book Reader OCR - 遠端客戶端版本
============================================================

🔐 正在生成 SSL 自簽憑證...

✅ 使用現有 SSL 憑證: 憑證有效，將於 365 天後過期

------------------------------------------------------------
🔒 HTTPS 模式（Webcam 可用）
🌐 本機網址: https://localhost:8502
🌐 區網網址: https://192.168.1.100:8502
⚠️  首次連接請接受自簽憑證警告
------------------------------------------------------------
📡 用戶可以使用自己設備的 Webcam 進行 OCR
📁 圖片儲存路徑: /path/to/captured_images
============================================================
```

## 依賴套件

SSL 自動憑證功能需要 `cryptography` 套件：

```bash
pip install cryptography>=41.0.0
```

如果沒有安裝此套件，程式會顯示警告並退回使用 HTTP 模式。

## 檔案說明

| 檔案 | 說明 |
|------|------|
| `cert.pem` | SSL 憑證檔案（自動生成） |
| `key.pem` | SSL 私鑰檔案（自動生成） |

這些檔案會在程式首次執行時自動建立於 `example_bookReader/` 目錄下。

## 憑證規格

- **演算法**: RSA 2048-bit
- **雜湊**: SHA-256
- **有效期**: 365 天（可自訂）
- **Subject Alternative Names**:
  - `localhost`
  - `*.localhost`
  - `127.0.0.1`
  - `::1`
  - 本機所有 IPv4 地址

## 安全注意事項

1. **自簽憑證警告**：瀏覽器會顯示安全警告，這是正常現象，點擊「進階」→「繼續前往」即可
2. **私鑰保護**：`key.pem` 檔案權限設為 600（僅擁有者可讀寫）
3. **僅限開發/內網使用**：自簽憑證適合開發環境和內網使用，不適合公開網站

## 常見問題

### Q: 為什麼需要 HTTPS？

A: 現代瀏覽器基於安全考量，只允許在安全環境（HTTPS 或 localhost）下使用 `getUserMedia` API 存取 Webcam。

### Q: 如何強制重新生成憑證？

A: 刪除 `cert.pem` 和 `key.pem` 檔案，然後重新執行程式：

```bash
rm cert.pem key.pem
python book_reader_remote.py
```

### Q: 如何使用自己的憑證？

A: 將您的憑證檔案命名為 `cert.pem` 和 `key.pem`，放在 `example_bookReader/` 目錄下即可。

### Q: 憑證過期了怎麼辦？

A: 程式會自動檢查憑證有效期，如果即將過期（7天內）或已過期，會自動重新生成。

## 相關程式碼

`SSLCertificateManager` 類別位於 `book_reader_remote.py`，提供以下方法：

| 方法 | 說明 |
|------|------|
| `check_certificates_exist()` | 檢查憑證檔案是否存在 |
| `check_certificate_valid()` | 檢查憑證是否有效（未過期） |
| `generate_self_signed_certificate()` | 生成自簽 SSL 憑證 |
| `ensure_certificates()` | 確保憑證存在且有效 |
| `get_ssl_context()` | 獲取 SSL context 所需的檔案路徑 |

## 版本歷史

- **2025-12-02**: 新增 SSL 自動憑證功能

